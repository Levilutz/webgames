name: user-api

on: push

env:
  DOCKER_REPO: "docker.io/levilutz/webgames-user-api"

jobs:
  api-build-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Build
        run: docker build user-api/api -t api

      - name: Push
        run: |
          docker login --username ${{ secrets.DOCKER_USERNAME }} --password ${{ secrets.DOCKER_PASSWORD }}
          tag="${GITHUB_SHA}-api"
          docker tag api $DOCKER_REPO:$tag
          docker push $DOCKER_REPO:$tag

  migrations-build-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Build
        run: docker build user-api/migrate -t migrations

      - name: Push
        run: |
          docker login --username ${{ secrets.DOCKER_USERNAME }} --password ${{ secrets.DOCKER_PASSWORD }}
          tag="${GITHUB_SHA}-migrations"
          docker tag migrations $DOCKER_REPO:$tag
          docker push $DOCKER_REPO:$tag
